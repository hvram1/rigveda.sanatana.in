---
import VerseLayout from '../../../../layouts/VerseLayout.astro';
import VerseCard from '../../../../components/VerseCard.astro';
import AudioPlayer from '../../../../components/AudioPlayer.astro';
import SvaranugamiOverlay from '../../../../components/SvaranugamiOverlay.astro';
import { loadRik, MANDALA_NAMES, padNumber, loadSuktaSyncData } from '../../../../lib/utils';
import { getAudioUrl, FEATURES } from '../../../../lib/config';
import fs from 'fs';
import path from 'path';

export function getStaticPaths() {
  const paths: { params: { mandala: string; sukta: string; rik: string } }[] = [];
  
  for (let m = 1; m <= 10; m++) {
    const mandalaPath = path.join(process.cwd(), 'src/data', padNumber(m));
    try {
      const suktas = fs.readdirSync(mandalaPath).filter(d => !d.startsWith('.'));
      
      for (const s of suktas) {
        const suktaPath = path.join(mandalaPath, s);
        const riks = fs.readdirSync(suktaPath).filter(f => f.endsWith('.json'));
        
        for (const r of riks) {
          const rikNum = r.replace('.json', '');
          paths.push({ 
            params: { 
              mandala: String(m), 
              sukta: String(parseInt(s, 10)), 
              rik: String(parseInt(rikNum, 10)) 
            } 
          });
        }
      }
    } catch {}
  }
  
  return paths;
}

const { mandala, sukta, rik: rikParam } = Astro.params;
const mandalaNum = parseInt(mandala, 10);
const suktaNum = parseInt(sukta, 10);
const rikNum = parseInt(rikParam, 10);

const rikData = await loadRik(mandalaNum, suktaNum, rikNum);
const audioUrl = getAudioUrl(mandalaNum, suktaNum, rikNum);

// Load sync data for this single rik (filter from sukta sync data)
let svaranugamiVerses: any[] = [];
if (rikData) {
  const suktaSyncData = loadSuktaSyncData(mandalaNum, suktaNum, [rikData]);
  svaranugamiVerses = suktaSyncData.filter(v => v.rik === rikNum);
}
---

<VerseLayout 
  title={`ऋक् ${mandala}.${sukta}.${rikParam}`}
  currentMandala={mandalaNum}
  currentSukta={suktaNum}
  currentRik={rikNum}
>
  {rikData ? (
    <>
      <div class="player-row mb-6">
        <AudioPlayer src={audioUrl} />
        
        {FEATURES.svaranugami && svaranugamiVerses.length > 0 && (
          <SvaranugamiOverlay 
            verses={svaranugamiVerses} 
            level="rik" 
            title={`ऋक् ${mandala}.${sukta}.${rikParam} - स्वरानुगामी`}
          />
        )}
      </div>

      <VerseCard rik={rikData} showDetails={true} />

      <aside class="mt-6 verse-card">
        <h3 class="font-semibold text-terracotta mb-3">वर्गीकरणम्</h3>
        <dl class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <dt class="text-gray-500">अष्टकः</dt>
            <dd class="font-medium">{rikData.classification.ashtaka}</dd>
          </div>
          <div>
            <dt class="text-gray-500">अध्यायः</dt>
            <dd class="font-medium">{rikData.classification.adhyaya}</dd>
          </div>
          <div>
            <dt class="text-gray-500">वर्गः</dt>
            <dd class="font-medium">{rikData.classification.varga}</dd>
          </div>
          <div>
            <dt class="text-gray-500">अनुवाकः</dt>
            <dd class="font-medium">{rikData.classification.anuvaka}</dd>
          </div>
        </dl>
      </aside>
    </>
  ) : (
    <div class="verse-card text-center">
      <h1 class="text-2xl text-maroon">ऋक् not found</h1>
      <p class="mt-2">The requested verse could not be located.</p>
      <a href="/" class="nav-link inline-block mt-4 bg-saffron/20">Return Home</a>
    </div>
  )}
</VerseLayout>

<style>
  .player-row {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    flex-wrap: wrap;
  }
  
  .player-row > :first-child {
    flex: 1;
    min-width: 250px;
  }
  
  @media (max-width: 768px) {
    .player-row {
      flex-direction: column;
    }
    
    .player-row > :first-child {
      width: 100%;
    }
  }
</style>
